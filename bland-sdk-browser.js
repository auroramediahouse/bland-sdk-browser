!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.BlandSDK=e():t.BlandSDK=e()}(this,(()=>(()=>{"use strict";var t={228:t=>{var e=Object.prototype.hasOwnProperty,n="~";function i(){}function o(t,e,n){this.fn=t,this.context=e,this.once=n||!1}function a(t,e,i,a,r){if("function"!=typeof i)throw new TypeError("The listener must be a function");var s=new o(i,a||t,r),u=n?n+e:e;return t._events[u]?t._events[u].fn?t._events[u]=[t._events[u],s]:t._events[u].push(s):(t._events[u]=s,t._eventsCount++),t}function r(t,e){0==--t._eventsCount?t._events=new i:delete t._events[e]}function s(){this._events=new i,this._eventsCount=0}Object.create&&(i.prototype=Object.create(null),(new i).__proto__||(n=!1)),s.prototype.eventNames=function(){var t,i,o=[];if(0===this._eventsCount)return o;for(i in t=this._events)e.call(t,i)&&o.push(n?i.slice(1):i);return Object.getOwnPropertySymbols?o.concat(Object.getOwnPropertySymbols(t)):o},s.prototype.listeners=function(t){var e=n?n+t:t,i=this._events[e];if(!i)return[];if(i.fn)return[i.fn];for(var o=0,a=i.length,r=new Array(a);o<a;o++)r[o]=i[o].fn;return r},s.prototype.listenerCount=function(t){var e=n?n+t:t,i=this._events[e];return i?i.fn?1:i.length:0},s.prototype.emit=function(t,e,i,o,a,r){var s=n?n+t:t;if(!this._events[s])return!1;var u,l,c=this._events[s],p=arguments.length;if(c.fn){switch(c.once&&this.removeListener(t,c.fn,void 0,!0),p){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,e),!0;case 3:return c.fn.call(c.context,e,i),!0;case 4:return c.fn.call(c.context,e,i,o),!0;case 5:return c.fn.call(c.context,e,i,o,a),!0;case 6:return c.fn.call(c.context,e,i,o,a,r),!0}for(l=1,u=new Array(p-1);l<p;l++)u[l-1]=arguments[l];c.fn.apply(c.context,u)}else{var d,h=c.length;for(l=0;l<h;l++)switch(c[l].once&&this.removeListener(t,c[l].fn,void 0,!0),p){case 1:c[l].fn.call(c[l].context);break;case 2:c[l].fn.call(c[l].context,e);break;case 3:c[l].fn.call(c[l].context,e,i);break;case 4:c[l].fn.call(c[l].context,e,i,o);break;default:if(!u)for(d=1,u=new Array(p-1);d<p;d++)u[d-1]=arguments[d];c[l].fn.apply(c[l].context,u)}}return!0},s.prototype.on=function(t,e,n){return a(this,t,e,n,!1)},s.prototype.once=function(t,e,n){return a(this,t,e,n,!0)},s.prototype.removeListener=function(t,e,i,o){var a=n?n+t:t;if(!this._events[a])return this;if(!e)return r(this,a),this;var s=this._events[a];if(s.fn)s.fn!==e||o&&!s.once||i&&s.context!==i||r(this,a);else{for(var u=0,l=[],c=s.length;u<c;u++)(s[u].fn!==e||o&&!s[u].once||i&&s[u].context!==i)&&l.push(s[u]);l.length?this._events[a]=1===l.length?l[0]:l:r(this,a)}return this},s.prototype.removeAllListeners=function(t){var e;return t?(e=n?n+t:t,this._events[e]&&r(this,e)):(this._events=new i,this._eventsCount=0),this},s.prototype.off=s.prototype.removeListener,s.prototype.addListener=s.prototype.on,s.prefixed=n,s.EventEmitter=s,t.exports=s}},e={};function n(i){var o=e[i];if(void 0!==o)return o.exports;var a=e[i]={exports:{}};return t[i](a,a.exports,n),a.exports}n.d=(t,e)=>{for(var i in e)n.o(e,i)&&!n.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),n.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),n.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var i={};n.r(i),n.d(i,{BlandWebClient:()=>h});var o=n(228),a=null;"undefined"!=typeof WebSocket?a=WebSocket:"undefined"!=typeof MozWebSocket?a=MozWebSocket:void 0!==n.g?a=n.g.WebSocket||n.g.MozWebSocket:"undefined"!=typeof window?a=window.WebSocket||window.MozWebSocket:"undefined"!=typeof self&&(a=self.WebSocket||self.MozWebSocket);const r=a;var s,u=(s=function(t,e){return s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},s(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=t}s(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}),l=function(t,e,n,i){return new(n||(n=Promise))((function(o,a){function r(t){try{u(i.next(t))}catch(t){a(t)}}function s(t){try{u(i.throw(t))}catch(t){a(t)}}function u(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,s)}u((i=i.apply(t,e||[])).next())}))},c=function(t,e){var n,i,o,a,r={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(s){return function(u){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;a&&(a=0,s[0]&&(r=0)),r;)try{if(n=1,i&&(o=2&s[0]?i.return:s[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,s[1])).done)return o;switch(i=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return r.label++,{value:s[1],done:!1};case 5:r.label++,i=s[1],s=[0];continue;case 7:s=r.ops.pop(),r.trys.pop();continue;default:if(!((o=(o=r.trys).length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){r=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){r.label=s[1];break}if(6===s[0]&&r.label<o[1]){r.label=o[1],o=s;break}if(o&&r.label<o[2]){r.label=o[2],r.ops.push(s);break}o[2]&&r.ops.pop(),r.trys.pop();continue}s=e.call(t,r)}catch(t){s=[6,t],i=0}finally{n=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,u])}}};function p(t){for(var e=new ArrayBuffer(2*t.length),n=new DataView(e),i=0;i<t.length;i++){var o=32768*t[i];n.setInt16(2*i,o,!0)}return new Uint8Array(e)}var d=function(t){function e(e){var n=t.call(this)||this;n.pingTimeout=null,n.pingInterval=null,n.wasDisconnected=!1,n.pingIntervalTime=5e3,n.audioIndex=0,n.marks=[];var i="wss://api.staging.bland.ai"+"?agent=".concat(e.agentId,"&token=").concat(e.sessionToken);return n.ws=new r(i),n.ws.binaryType="arraybuffer",n.ws.onopen=function(){n.emit("open")},n.ws.onmessage=function(t){var e;if("string"==typeof t.data&&"pong"===t.data)n.wasDisconnected&&(n.emit("reconnect"),n.wasDisconnected=!1),n.adjustPingFrequency(5e3);else if(t.data instanceof ArrayBuffer){var i=new Uint8Array(t.data);n.audioIndex++,n.emit("audio",i)}else if("string"==typeof t.data)if("clear"===t.data)n.emit("clear");else{var o=JSON.parse(t.data),a=null==o?void 0:o.event,r=null===(e=null==o?void 0:o.mark)||void 0===e?void 0:e.name;"mark"===a?n.emit("mark",r):"update"===a&&n.emit("update",o)}},n.ws.onclose=function(t){n.emit("close",t.code,t.reason)},n.ws.onerror=function(t){n.emit("error",t)},n}return u(e,t),e.prototype.sendPing=function(){1===this.ws.readyState&&this.ws.send("ping")},e.prototype.resetPingTimeout=function(){var t=this;null!=this.pingTimeout&&clearTimeout(this.pingTimeout),this.pingTimeout=setTimeout((function(){5e3===t.pingIntervalTime&&(t.adjustPingFrequency(1e3),t.pingTimeout=setTimeout((function(){t.emit("disconnect"),t.wasDisconnected=!0}),3e3))}),this.pingIntervalTime)},e.prototype.adjustPingFrequency=function(t){this.pingIntervalTime!==t&&(null!=this.pingInterval&&clearInterval(this.pingInterval),this.pingIntervalTime=t)},e.prototype.send=function(t){1===this.ws.readyState&&this.ws.send(t)},e.prototype.sendUtf=function(t){1===this.ws.readyState&&this.ws.send(t)},e.prototype.close=function(){this.ws.close()},e}(o),h=function(t){function e(e,n,i){var o=t.call(this)||this;return o.isCalling=!1,o.captureNode=null,o.audioData=[],o.audioDataIndex=0,o.isTalking=!1,o.marks=[],o.transcripts=[],o.lastProcessId="",i&&(o.customEndpoint=i),o.agentId=e,o.sessionToken=n,o.isTalking=!1,o}return u(e,t),e.prototype.isTalkingToAgent=function(){return this.isTalking},e.prototype.initConversation=function(t){return l(this,void 0,void 0,(function(){var e;return c(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,this.setupAudioPlayback(t.sampleRate,t.customStream)];case 1:return n.sent(),this.liveClient=new d({callId:"test",customEndpoint:this.customEndpoint,agentId:this.agentId,sessionToken:this.sessionToken}),this.handleAudioEvents(),this.isCalling=!0,[3,3];case 2:return e=n.sent(),this.emit("Error",e.message),[3,3];case 3:return[2]}}))}))},e.prototype.stopConversation=function(){var t,e,n,i,o;this.isCalling=!1,null===(t=this.liveClient)||void 0===t||t.close(),null===(e=this.audioContext)||void 0===e||e.suspend(),null===(n=this.audioContext)||void 0===n||n.close(),this.isAudioWorkletSupported()?(null===(i=this.audioNode)||void 0===i||i.disconnect(),this.audioNode=null):this.captureNode&&(this.captureNode.disconnect(),this.captureNode.onaudioprocess=null,this.captureNode=null,this.audioData=[],this.audioDataIndex=0),this.liveClient=null,null===(o=this.stream)||void 0===o||o.getTracks().forEach((function(t){return t.stop()})),this.audioContext=null,this.stream=null},e.prototype.setupAudioPlayback=function(t,e){return l(this,void 0,void 0,(function(){var n,i,o,a,r,s=this;return c(this,(function(u){switch(u.label){case 0:this.audioContext=new AudioContext({sampleRate:t}),u.label=1;case 1:return u.trys.push([1,4,,5]),n=this,(i=e)?[3,3]:[4,navigator.mediaDevices.getUserMedia({audio:{sampleRate:t,echoCancellation:!0,noiseSuppression:!0,channelCount:1}})];case 2:i=u.sent(),u.label=3;case 3:return n.stream=i,[3,5];case 4:throw u.sent(),new Error("User rejected microphone access");case 5:return this.isAudioWorkletSupported()?(this.audioContext.resume(),o=new Blob(['\nclass captureAndPlaybackProcessor extends AudioWorkletProcessor {\n  audioData = [];\n  index = 0;\n  isTalking = false;\n  marks = [];\n\n  constructor() {\n      super();\n\n      this.port.onmessage = (e) => {\n        console.log({ e })\n          if (e.data === "clear") {\n              this.audioData = [];\n              this.index = 0;\n\n              this.clearAllMarkMessages();\n\n              if (this.isTalking) {\n                  this.isTalking = false;\n                  this.port.postMessage("agent_stop_talking");\n              }\n          } else if (typeof e.data === "string") {\n              this.pushMarkMessage(e.data);\n          } else if (e.data.length > 0) {\n              this.audioData.push(this.convertUint8ToFloat32(e.data));\n              if (!this.isTalking) {\n                  this.isTalking = true;\n                  this.port.postMessage("agent_start_talking");\n              }\n          } else {\n            console.log("unrecognized message", e)\n          }\n      };\n  }\n\n  sendMarkMessage(message) {\n      this.port.postMessage(["mark", message]);\n  }\n\n  pushMarkMessage(message) {\n      if (this.index == 0) {\n          this.sendMarkMessage(message);\n          return;\n      }\n      this.marks.push(message)\n  }\n\n  clearAllMarkMessages() {\n      for (const message of this.marks) {\n          this.sendMarkMessage(message)\n      }\n      this.marks = [];\n  }\n\n  convertUint8ToFloat32(array) {\n      const targetArray = new Float32Array(array.byteLength / 2);\n\n      // A DataView is used to read our 16-bit little-endian samples out of the Uint8Array buffer\n      const sourceDataView = new DataView(array.buffer);\n\n      // Loop through, get values, and divide by 32,768\n      for (let i = 0; i < targetArray.length; i++) {\n          targetArray[i] = sourceDataView.getInt16(i * 2, true) / Math.pow(2, 16 - 1);\n      }\n      return targetArray;\n  }\n\n  convertFloat32ToUint8(array) {\n      const buffer = new ArrayBuffer(array.length * 2);\n      const view = new DataView(buffer);\n\n      for (let i = 0; i < array.length; i++) {\n          const value = array[i] * 32768;\n          view.setInt16(i * 2, value, true); // true for little-endian\n      }\n\n      return new Uint8Array(buffer);\n  }\n\n  process(inputs, outputs, parameters) {\n      // Capture\n      const input = inputs[0];\n      const inputChannel1 = input[0];\n      const inputChannel2 = input[1];\n      this.port.postMessage(["capture", this.convertFloat32ToUint8(inputChannel1)]);\n\n      // Playback\n      const output = outputs[0];\n      const outputChannel1 = output[0];\n      const outputChannel2 = output[1];\n      // start playback.\n      for (let i = 0; i < outputChannel1.length; ++i) {\n          if (this.audioData.length > 0) {\n              outputChannel1[i] = this.audioData[0][this.index];\n              outputChannel2[i] = this.audioData[0][this.index];\n              this.index++;\n              if (this.index == this.audioData[0].length) {\n                  this.audioData.shift();\n                  this.index = 0;\n              }\n          } else {\n              outputChannel1[i] = 0;\n              outputChannel2[i] = 0;\n          }\n      }\n\n      this.port.postMessage(["playback", this.convertFloat32ToUint8(outputChannel1)]);\n      if (!this.audioData.length && this.isTalking) {\n          this.isTalking = false;\n          this.port.postMessage("agent_stop_talking");\n          this.clearAllMarkMessages();\n      }\n\n      return true;\n  }\n}\n\nregisterProcessor(\n  "capture-and-playback-processor",\n  captureAndPlaybackProcessor,\n);\n'],{type:"application/javascript"}),a=URL.createObjectURL(o),[4,this.audioContext.audioWorklet.addModule(a)]):[3,7];case 6:return u.sent(),this.audioNode=new AudioWorkletNode(this.audioContext,"capture-and-playback-processor"),this.audioNode.port.onmessage=function(t){var e,n,i=t.data;if(Array.isArray(i)){var o=i[0];"capture"===o?null===(e=s.liveClient)||void 0===e||e.send(i[1]):"playback"===o?s.emit("audio",i[1]):"mark"===o&&(null===(n=s.liveClient)||void 0===n||n.sendUtf(JSON.stringify({event:"mark",mark:{name:i[1]}})))}else"agent_stop_talking"===i?(s.emit("agentStopTalking"),s.emit("userStartTalking")):"agent_start_talking"===i&&(s.emit("agentStartTalking"),s.emit("userStopTalking"))},(r=this.audioContext.createMediaStreamSource(this.stream)).connect(this.audioNode),this.audioNode.connect(this.audioContext.destination),[3,8];case 7:r=this.audioContext.createMediaStreamSource(this.stream),this.captureNode=this.audioContext.createScriptProcessor(2048,1,1),this.captureNode.onaudioprocess=function(t){if(s.isCalling){for(var e=t.inputBuffer.getChannelData(0),n=p(e),i=e.length,o=new Int16Array(i),a=0;a<i;a++){var r=Math.max(-1,Math.min(1,e[a]));o[a]=32767*r}s.liveClient.send(n);var u=t.outputBuffer.getChannelData(0);for(a=0;a<u.length;++a)s.audioData.length>0?(u[a]=s.audioData[0][s.audioDataIndex++],s.audioDataIndex===s.audioData[0].length&&(s.audioData.shift(),s.audioDataIndex=0)):u[a]=0;s.emit("audio",p(u)),!s.audioData.length&&s.isTalking&&(s.isTalking=!1,s.clearMarkMessages(),s.emit("agentStopTalking"))}},r.connect(this.captureNode),this.captureNode.connect(this.audioContext.destination),u.label=8;case 8:return[2]}}))}))},e.prototype.handleAudioEvents=function(){var t=this;this.liveClient.on("open",(function(){t.emit("conversationStarted")})),this.liveClient.on("audio",(function(e){t.playAudio(e)})),this.liveClient.on("disconnect",(function(){t.emit("disconnect")})),this.liveClient.on("reconnect",(function(){t.emit("reconnect")})),this.liveClient.on("error",(function(e){t.emit("error",e),t.isCalling&&t.stopConversation()})),this.liveClient.on("close",(function(e,n){t.isCalling&&t.stopConversation(),t.emit("conversationEnded",{code:e,reason:n})})),this.liveClient.on("mark",(function(e){t.isAudioWorkletSupported()?t.audioNode.port.postMessage(e):t.isTalking?t.marks.push(e):t.liveClient.sendUtf(JSON.stringify({event:"mark",mark:{name:e}}))})),this.liveClient.on("update",(function(e){(null==e?void 0:e.payload)&&t.emit("transcripts",null==e?void 0:e.payload)})),this.liveClient.on("clear",(function(){t.isAudioWorkletSupported()?t.audioNode.port.postMessage("clear"):(t.audioData=[],t.audioDataIndex=0,t.isTalking&&(t.isTalking=!1,t.clearMarkMessages(),t.emit("agentStopTalking")))}))},e.prototype.handleNewUpdate=function(t){var e;if(t.processId&&t.packetId&&t.text&&0!==(null===(e=t.text)||void 0===e?void 0:e.length)){var n=this.transcripts.find((function(e){return e.processId===t.processId&&e.type===t.type}))||null;n?(n.text+=" ".concat(t.text),n.complete=t.complete):(this.transcripts.push(t),n=t)}},e.prototype.clearMarkMessages=function(){for(var t=0,e=this.marks;t<e.length;t++){var n=e[t];this.liveClient.sendUtf(JSON.stringify({event:"mark",mark:{name:n}}))}this.marks=[]},e.prototype.isAudioWorkletSupported=function(){return/Chrome/.test(navigator.userAgent)&&/Google Inc/.test(navigator.vendor)},e.prototype.playAudio=function(t){if(this.isAudioWorkletSupported())this.audioNode.port.postMessage(t);else{var e=function(t){for(var e=new Float32Array(t.byteLength/2),n=new DataView(t.buffer),i=0;i<e.length;i++)e[i]=n.getInt16(2*i,!0)/Math.pow(2,15);return e}(t);this.audioData.push(e),this.isTalking||(this.isTalking=!0,this.emit("agentStartTalking"))}},e}(o);return i})()));